From 91e001d5c1c88d858ed20ab83fc79b4c16f7fcbd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Alfonso=20S=C3=A1nchez-Beato?=
 <alfonso.sanchez-beato@canonical.com>
Date: Thu, 21 Mar 2024 08:17:29 +0000
Subject: [PATCH] snap: do not tinker with uid/gid, change fixed paths

---
 src/config.h  |  6 +++---
 src/dnsmasq.c | 19 -------------------
 2 files changed, 3 insertions(+), 22 deletions(-)

diff --git a/src/config.h b/src/config.h
index e722e98..4290e77 100644
--- a/src/config.h
+++ b/src/config.h
@@ -214,7 +214,7 @@ RESOLVFILE
 #   elif defined(__ANDROID__)
 #      define LEASEFILE "/data/misc/dhcp/dnsmasq.leases"
 #   else
-#      define LEASEFILE "/var/lib/misc/dnsmasq.leases"
+#      define LEASEFILE "/var/snap/network-manager/current/var/lib/misc/dnsmasq.leases"
 #   endif
 #endif
 
@@ -222,7 +222,7 @@ RESOLVFILE
 #   if defined(__FreeBSD__)
 #      define CONFFILE "/usr/local/etc/dnsmasq.conf"
 #   else
-#      define CONFFILE "/etc/dnsmasq.conf"
+#      define CONFFILE "/var/snap/network-manager/current/etc/dnsmasq.conf"
 #   endif
 #endif
 
@@ -238,7 +238,7 @@ RESOLVFILE
 #   if defined(__ANDROID__)
 #      define RUNFILE "/data/dnsmasq.pid"
 #    else
-#      define RUNFILE "/var/run/dnsmasq.pid"
+#      define RUNFILE "/var/snap/network-manager/current/var/run/dnsmasq.pid"
 #    endif
 #endif
 
diff --git a/src/dnsmasq.c b/src/dnsmasq.c
index 30fb419..da1abed 100644
--- a/src/dnsmasq.c
+++ b/src/dnsmasq.c
@@ -678,8 +678,6 @@ int main (int argc, char **argv)
 		 of the directory containing the file. That directory will
 		 need to by owned by the dnsmasq user, and the ownership of the
 		 file has to match, to keep systemd >273 happy. */
-	      if (getuid() == 0 && ent_pw && ent_pw->pw_uid != 0 && fchown(fd, ent_pw->pw_uid, ent_pw->pw_gid) == -1)
-		chown_warn = errno;
 
 	      if (!read_write(fd, (unsigned char *)daemon->namebuff, strlen(daemon->namebuff), 0))
 		err = 1;
@@ -728,16 +726,6 @@ int main (int argc, char **argv)
   if (!option_bool(OPT_DEBUG) && getuid() == 0)   
     {
       int bad_capabilities = 0;
-      gid_t dummy;
-      
-      /* remove all supplementary groups */
-      if (gp && 
-	  (setgroups(0, &dummy) == -1 ||
-	   setgid(gp->gr_gid) == -1))
-	{
-	  send_event(err_pipe[1], EVENT_GROUP_ERR, errno, daemon->groupname);
-	  _exit(0);
-	}
   
       if (ent_pw && ent_pw->pw_uid != 0)
 	{     
@@ -777,13 +765,6 @@ int main (int argc, char **argv)
 	      _exit(0);
 	    }
 	  
-	  /* finally drop root */
-	  if (setuid(ent_pw->pw_uid) == -1)
-	    {
-	      send_event(err_pipe[1], EVENT_USER_ERR, errno, daemon->username);
-	      _exit(0);
-	    }     
-
 #ifdef HAVE_LINUX_NETWORK
 	  data->effective &= ~(1 << CAP_SETUID);
 	  data->permitted &= ~(1 << CAP_SETUID);
-- 
2.34.1

