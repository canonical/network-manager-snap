summary: Verify that netplan configuration files are immutable

execute: |
    . "$SYSTEMSNAPSTESTLIB"/utilities.sh
    get_qemu_eth_iface eth_if

    # Ensure we're using a configuration generated from netplan
    test -e /etc/netplan/"$DEFAULT_NETPLAN_FILE"
    test -e /run/NetworkManager/system-connections/netplan-$eth_if.nmconnection
    # And that we're not connected to a volatile connection generated by NM
    /snap/bin/network-manager.nmcli c up netplan-$eth_if

    /snap/bin/network-manager.nmcli c | MATCH "netplan-$eth_if.*$eth_if"
    # Try to change the DNS server used on this connection
    test ! $(/snap/bin/network-manager.nmcli c modify netplan-$eth_if ipv4.dns 8.8.8.8)
